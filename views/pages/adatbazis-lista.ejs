<%- include('../partials/header') %>

<main class="py-4">

    <% 
        // Statisztikák számítása
        let varosDb = 0;

        if (Array.isArray(varosAdatok) && varosAdatok.length > 0) {
            const egyediVarosok = new Set();
            varosAdatok.forEach(sor => egyediVarosok.add(sor.varosNev));
            varosDb = egyediVarosok.size;
        }
    %>

    <!-- Fejléc -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
            <h1 class="h4 fw-bold mb-1">Városlista</h1>
            <p class="text-muted mb-0">
                Városok, megyék és lakosságszám adatok.
            </p>
        </div>

        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary">
                Összes város: <strong><%= varosDb %></strong>
            </span>
            <span class="badge bg-secondary">
                Sorok: <strong><%= varosAdatok.length %></strong>
            </span>
        </div>
    </div>

    <!-- Szűrés (szerver oldali) -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form class="row g-3 align-items-end" method="get" action="/adatbazis-lista">

                <div class="col-md-4">
                    <label class="form-label">Megye</label>
                    <select name="megye" id="megyeSelect" class="form-select">
                        <option value="">-- Összes megye --</option>
                        <% megyeNevek.forEach(m => { %>
                            <option value="<%= m.nev %>" <%= szures.megye === m.nev ? 'selected' : '' %>>
                                <%= m.nev %>
                            </option>
                        <% }) %>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Város</label>
                    <select name="varos" id="varosSelect" class="form-select">
                        <option value="">-- Összes város --</option>
                        <% varosNevek.forEach(v => { %>
                            <option value="<%= v.nev %>" <%= szures.varos === v.nev ? 'selected' : '' %>>
                                <%= v.nev %>
                            </option>
                        <% }) %>
                    </select>
                </div>

                <div class="col-md-4 d-flex gap-2">
                    <button class="btn btn-primary w-100">Szűrés</button>
                    <a href="/adatbazis-lista" class="btn btn-outline-secondary">Törlés</a>
                </div>

            </form>
        </div>
    </div>

    <!-- Keresés (kliens oldali, optimalizált) -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <label class="form-label">Keresés</label>
            <input type="text" id="search" class="form-control" placeholder="Pl.: Budapest, Baranya, 2020, 150000...">
            <small class="text-muted">
                A táblázat minden oszlopára keres (kisebb listáknál). Nagy adatbázisnál automatikusan letiltásra kerül.
            </small>
        </div>
    </div>

    <!-- Táblázat -->
    <div class="card shadow-sm">
        <div class="table-responsive">
            <% if (!varosAdatok || varosAdatok.length === 0) { %>

                <p class="m-3 text-muted">Nincs megjeleníthető adat.</p>

            <% } else { %>

                <table class="table table-hover align-middle mb-0" id="varos-table">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Város</th>
                            <th>Megye</th>
                            <th>Év</th>
                            <th class="text-end">Nők száma</th>
                            <th class="text-end">Összlélekszám</th>
                        </tr>
                    </thead>

                    <tbody>
                        <% varosAdatok.forEach((sor, i) => { %>
                            <tr>
                                <td><%= i + 1 %></td>
                                <td><%= sor.varosNev %></td>
                                <td><%= sor.megyeNev %></td>
                                <td><%= sor.ev || '-' %></td>
                                <td class="text-end">
                                    <%= sor.no != null ? sor.no.toLocaleString('hu-HU') : '-' %>
                                </td>
                                <td class="text-end">
                                    <%= sor.osszesen != null ? sor.osszesen.toLocaleString('hu-HU') : '-' %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>

            <% } %>
        </div>
    </div>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("search");
    const tbody = document.querySelector("#varos-table tbody");
    const megyeSelect = document.getElementById("megyeSelect");
    const varosSelect = document.getElementById("varosSelect");

    // ---------- MEGYE -> VÁROS DINAMIKUS SZŰRÉS (API VAL) ----------

    async function frissitVarosLista(megyeNev, kijeloltVaros) {
        try {
            // API hívás: /api/varosok-by-megye?megye=...
            const url = megyeNev ? `/api/varosok-by-megye?megye=${encodeURIComponent(megyeNev)}` 
                                 : '/api/varosok-by-megye';
            const res = await fetch(url);
            if (!res.ok) return;
            const varosok = await res.json();

            // Város select újraépítése
            varosSelect.innerHTML = '<option value="">-- Összes város --</option>';
            varosok.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.nev;
                opt.textContent = v.nev;
                varosSelect.appendChild(opt);
            });

            if (kijeloltVaros) {
                varosSelect.value = kijeloltVaros;
            }
        } catch (err) {
            console.error('Hiba a városlista frissítésekor:', err);
        }
    }

    if (megyeSelect && varosSelect) {
        const kezdetiMegye = megyeSelect.value;
        const kezdetiVaros = varosSelect.value;

        // Oldal betöltéskor, ha már ki van választva megye, szűrt városlista töltése
        if (kezdetiMegye) {
            frissitVarosLista(kezdetiMegye, kezdetiVaros);
        }

        // Ha megye változik, frissítjük a város listát, és töröljük az aktuális választást
        megyeSelect.addEventListener("change", () => {
            const ujMegye = megyeSelect.value;
            frissitVarosLista(ujMegye, "");
        });
    }

    // ---------- KLIENS OLDALI KERESÉS (OPTIMALIZÁLVA) ----------

    if (!input || !tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr"));
    const MAX_ROWS_FOR_CLIENT_SEARCH = 3000;

    // Ha túl sok sor van, kikapcsoljuk a keresőt (fagyás ellen)
    if (rows.length > MAX_ROWS_FOR_CLIENT_SEARCH) {
        input.value = "";
        input.placeholder = "Túl sok sor az azonnali kereséshez – használd a megye/város szűrőket.";
        input.disabled = true;
        return;
    }

    let timer = null;

    input.addEventListener("input", function () {
        const q = this.value.toLowerCase();

        clearTimeout(timer);
        timer = setTimeout(() => {
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(q) ? "" : "none";
            });
        }, 200);
    });
});
</script>

<%- include('../partials/footer') %>
